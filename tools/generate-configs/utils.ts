import { writeFile } from 'node:fs/promises';
import { resolve } from 'node:path';

import { format, resolveConfig } from 'prettier';

import type { TSESLint } from '@typescript-eslint/utils';

const __dirname = new URL('.', import.meta.url).pathname;

const prettierConfig = resolveConfig(__dirname);

const addAutoGeneratedComment = (code: string) =>
	[
		'// THIS CODE WAS AUTOMATICALLY GENERATED',
		'// DO NOT EDIT THIS CODE BY HAND',
		'// YOU CAN REGENERATE IT USING pnpm run generate:configs',
		'',
		code,
	].join('\n');

/**
 * Helper function writes configuration.
 */
export const writeConfig = async (
	config: TSESLint.Linter.ConfigType,
	configName: string
): Promise<void> => {
	// note: we use `export =` because ESLint will import these configs via a commonjs import
	const code = `import type { Linter } from 'eslint';

	export default ${JSON.stringify(config)} satisfies Linter.LegacyConfig;
	`;
	const configStr = await format(addAutoGeneratedComment(code), {
		parser: 'typescript',
		...(await prettierConfig),
	});
	const filePath = resolve(__dirname, `../../lib/configs/${configName}.ts`);

	await writeFile(filePath, configStr);
};
